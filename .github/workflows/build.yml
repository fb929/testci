name: Build

on:
  workflow_dispatch:

permissions:
  contents: 'write'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - macos-14
          - ubuntu-latest
          - windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute nightly version
        id: nightly_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # required for gh CLI to authenticate
        run: |
          set -euo pipefail
          DATE=$(date -u +'%Y%m%d')
          BASE_VERSION=$( jq -r '.version' package.json | sed 's/-.*$//' )
          PREFIX="v${BASE_VERSION}-nightly.${DATE}"

          # Get the number of existing tags for today
          COUNT=$(gh api "/repos/${{ github.repository }}/git/matching-refs/tags/$PREFIX" --jq 'length')
          N=$((COUNT + 1))

          # Build the final version string
          VERSION="${PREFIX}.${N}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Debug
        run: |
          echo "nightly_info.version=${{ steps.nightly_info.outputs.version }}"
