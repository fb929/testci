name: Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: 'write'

jobs:
  nightly:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: git fetch --tags --force --prune

      - name: Compute nightly version
        id: nightly_info
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # required for gh CLI to authenticate
        run: |
          set -euo pipefail
          DATE=$(date -u +'%Y%m%d')
          BASE_VERSION=$( jq -r '.version' package.json | sed 's/-.*$//' )
          PREFIX="v${BASE_VERSION}-nightly.${DATE}"

          # Get the number of existing tags for today
          COUNT=$(gh api "repos/${{ github.repository }}/git/matching-refs/tags/$PREFIX" --jq 'length')
          N=$((COUNT + 1))

          # Build the final version string
          VERSION="${PREFIX}.${N}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Debug
        shell: bash
        run: |
          echo "nightly_info.version=${{ steps.nightly_info.outputs.version }}"

      - name: Create nightly tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.nightly_info.outputs.version }} ${{ github.sha }}
          git push --tags

  build:
    needs:
      - nightly
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - macos-14
          - ubuntu-latest
          - windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug
        shell: bash
        run: |
          echo "nightly_info.version=${{ steps.nightly.outputs.version }}"
