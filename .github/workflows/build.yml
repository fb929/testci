name: Release

on:
  push:
    tags:
      - v*
    branches:
      - main
      - nightly-ci-test
  workflow_dispatch:
    inputs:
      nightly-mode:
        description: 'Nightly build. Use staging network'
        required: true
        default: 'false'
  schedule:
    - cron: '0 0 * * *' # every day at midnight

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-12, ubuntu-latest, windows-latest]

    steps:
      - name: Set nightly mode for scheduled jobs
        if: github.event_name == 'schedule'
        run: |
          echo "NIGHTLY_MODE=true" >> ${{ runner.os == 'Windows' && 'env:GITHUB_ENV' || 'GITHUB_ENV' }}

      - name: Set nightly mode for branch `nightly-ci-test`
        if: github.ref == 'refs/heads/nightly-ci-test'
        run: |
          echo "NIGHTLY_MODE=true" >> ${{ runner.os == 'Windows' && 'env:GITHUB_ENV' || 'GITHUB_ENV' }}

      - name: Set nightly mode for manual or tag-based jobs
        if: github.event_name != 'schedule' && github.ref != 'refs/heads/nightly-ci-test'
        run: |
          echo "NIGHTLY_MODE=${{ github.event.inputs.nightly-mode }}" >> ${{ runner.os == 'Windows' && 'env:GITHUB_ENV' || 'GITHUB_ENV' }}

      - name: Print nightly mode
        run: |
          echo "Nightly mode is set to ${{ runner.os == 'Windows' && 'env:NIGHTLY_MODE' || 'NIGHTLY_MODE' }}"
