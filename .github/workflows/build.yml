name: Release

on:
  push:
  workflow_dispatch:
    inputs:
      channel:
        description: electron.builder channel
        required: true
        default: alpha
        type: choice
        options:
          - alpha
          - beta

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-12, ubuntu-latest, windows-latest]

    steps:
      - name: Set environment variables
        shell: bash
        run: |
          if [[ -z "${{ github.event.inputs.channel }}" ]]; then
            echo "CHANNEL=alpha" >> $GITHUB_ENV
          else
            echo "CHANNEL=${{ github.event.inputs.channel }}" >> $GITHUB_ENV
          fi

      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: debug vars
        shell: bash
        run: echo ${{ env.CHANNEL }}

      #- name: Nightly mode settings
      #  shell: bash
      #  run: |
      #    jq --tab --arg date "$(TZ=Europe/Berlin date +%Y%m%d%H%M)" '.version |= (. | split(".") | .[0] + "." + .[1] + "." + $date+"-${{ env.CHANNEL }}")' package.json > temp.json && mv temp.json package.json

      - name: Nightly mode settings
        shell: bash
        run: |
          jq --tab '
            .name = "anytype-dev" |
            .version = "0.43.100-alpha" |
            .description = "Anytype Nightly" |
            .build.appId = "com.anytype.anytype-dev" |
            .build.productName = "Anytype Nightly" |
            .build.protocols[0].name = "Anytype Nightly" |
            .build.mac.publish |= map(del(.url)) |
            .build.mac.publish[0].provider = "s3" |
            .build.mac.publish[0].bucket = "%NIGHTLY_AWS_S3_BUCKET%" |
            .build.mac.publish[0].region = "%NIGHTLY_AWS_REGION%" |
            .build.win.publish |= map(del(.url)) |
            .build.win.publish[0].provider = "s3" |
            .build.win.publish[0].bucket = "%NIGHTLY_AWS_S3_BUCKET%" |
            .build.win.publish[0].region = "%NIGHTLY_AWS_REGION%" |
            .build.linux.description = "Anytype Nightly" |
            .build.linux.desktop.Name = "Anytype Nightly" |
            .build.linux.publish |= map(del(.url)) |
            .build.linux.publish[0].provider = "s3" |
            .build.linux.publish[0].bucket = "%NIGHTLY_AWS_S3_BUCKET%" |
            .build.linux.publish[0].region = "%NIGHTLY_AWS_REGION%"
          ' package.json > package-nightly-new.json

      - name: debug cat package-nightly-new.json
        shell: bash
        run: |
          cat package-nightly-new.json
