name: Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: 'write'

jobs:
  diff-check:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.diff_check.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: git fetch --tags --force --prune
      - id: diff_check
        run: |
          LAST_TAG=$(git describe --tags --match 'v*-nightly.*' --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            # no nightly tag found in history
            echo "changed=true" >> "$GITHUB_OUTPUT"
          elif git diff --quiet "${LAST_TAG}..HEAD"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi
      - name: debug
        run: |
          echo "changed: ${{ steps.diff_check.outputs.changed }}"

  nightly-tag:
    needs:
      - diff-check
    if: needs.diff-check.outputs.changed == 'true' # run only if there is a diff
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.nightly_info.outputs.tag }}
      app_version: ${{ steps.nightly_info.outputs.app_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: git fetch --tags --force --prune

      - name: Compute nightly version
        id: nightly_info
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # required for gh CLI to authenticate
        run: |
          set -euo pipefail
          DATE=$(date -u +'%Y%m%d')
          BASE_VERSION=$( jq -r '.version' package.json | sed 's/-.*$//' )
          PREFIX="v${BASE_VERSION}-nightly.${DATE}"

          # Get the number of existing tags for today
          COUNT=$(gh api "repos/${{ github.repository }}/git/matching-refs/tags/$PREFIX" --jq 'length')
          N=$((COUNT + 1))

          # Build the final version string
          echo "tag=${PREFIX}.${N}" >> "$GITHUB_OUTPUT"

          # application version
          echo "app_version=${BASE_VERSION}.${N}" >> "$GITHUB_OUTPUT"

      - name: Debug
        shell: bash
        run: |
          echo "nightly tag: ${{ steps.nightly_info.outputs.tag }}"

      - name: Create nightly tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.nightly_info.outputs.tag }} ${{ github.sha }}
          git push --tags

  build:
    needs:
      - nightly-tag
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - macos-14
          - ubuntu-latest
          - windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug
        shell: bash
        run: |
          echo "nightly tag=${{ needs.nightly-tag.outputs.tag }}"
          echo "nightly app_version=${{ needs.nightly-tag.outputs.app_version }}"
